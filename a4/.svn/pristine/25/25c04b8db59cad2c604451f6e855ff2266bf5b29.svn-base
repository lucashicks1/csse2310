#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <netdb.h>
#include <csse2310a4.h>
#include <csse2310a3.h>

#define MAX_ARGS 2
#define MIN_ARGS 1


#define USAGE_MESSAGE "Usage: crackclient portnum [jobfile]\n"
#define JOB_FILE_MESSAGE "crackclient: unable to open job file \"%s\"\n"
#define CONNECTION_ERROR_MESSAGE "crackclient: unable to connect to port %s\n"

typedef enum {
    USAGE_ERROR = 1,
    JOB_FILE_ERROR = 2,
    CONNECTION_ERROR = 3,
    CONNECTION_TERMINATED = 4,
    OK = 0
} ExitStatus;

typedef struct {
    const char* portNum;
    char* jobFile;
} ClientDetails;

ClientDetails parse_command_line(int argc, char** argv);
int setup_connection(const char* port);

int main(int argc, char** argv) {
    ClientDetails clientDetails;
    int connFD;
    
    clientDetails = parse_command_line(argc, argv);
    connFD = setup_connection(clientDetails.portNum);

    if (connFD < 0) {
        fprintf(stderr, CONNECTION_ERROR_MESSAGE, clientDetails.portNum);
        exit(CONNECTION_ERROR);
    }

    return OK;
}

int setup_connection(const char* port) {
    struct addrinfo* ai = 0;
    struct addrinfo hints;
    memset(&hints, 0, sizeof(struct addrinfo));
    hints.ai_family = AF_INET;
    hints.ai_socktype = SOCK_STREAM;
    int err;
    if ((err = getaddrinfo("localhost", port, &hints, &ai))) {
        freeaddrinfo(ai);
        return -1;
    }

    int fd = socket(AF_INET, SOCK_STREAM, 0);
    if (connect(fd, ai->ai_addr, sizeof(struct sockaddr))) {
        return -1;
    }
    return fd;

}

ClientDetails parse_command_line(int argc, char** argv) {
    ClientDetails clientDetails = {.portNum = NULL, .jobFile = NULL};

    // Skip program name
    argc--;
    argv++;

    if (argc > MAX_ARGS || argc < MIN_ARGS) {
        fprintf(stderr, USAGE_MESSAGE);
        exit(USAGE_ERROR);
    }

    clientDetails.portNum = argv[0];

    if (argc == 2) {
        clientDetails.jobFile = argv[1];
        FILE* jobFile = fopen(argv[1], "r");
        if (!jobFile) {
            fprintf(stderr, JOB_FILE_MESSAGE, clientDetails.jobFile);
            exit(JOB_FILE_ERROR);
        }
    }

    return clientDetails;
}
